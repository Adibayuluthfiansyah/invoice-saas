generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

//  Model User (Pemilik akun invoice)
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  name             String?
  password         String
  createdAt        DateTime  @default(now())
  resetToken       String?   @unique // Secret Token reset password
  resetTokenExpiry DateTime? // Token kadaluarsa 

  // Relasi: Satu User punya satu profil bisnis & banyak customer/invoice
  businessProfile BusinessProfile?
  customers       Customer[]
  invoices        Invoice[]
}

// Model BusinessProfile (Data untuk Kop Surat/Header Invoice)
model BusinessProfile {
  id             String  @id @default(cuid())
  companyName    String
  address        String?
  logoUrl        String? // URL logo perusahaan
  taxId          String? // NPWP 
  invoiceTaxRate Float   @default(0)
  userId         String  @unique
  user           User    @relation(fields: [userId], references: [id])

  paymentClientKey String? // Untuk frontend 
  paymentServerKey String? // Untuk backend 
}

//  Model Customer (Klien yang ditagih)
model Customer {
  id      String  @id @default(cuid())
  name    String
  email   String
  address String?

  // Customer ke User ID.
  userId String
  user   User   @relation(fields: [userId], references: [id])

  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, userId])
}

// Model Invoice 
model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String
  issueDate     DateTime @default(now())
  dueDate       DateTime

  status InvoiceStatus @default(DRAFT)

  subTotal    Int   @default(0)
  taxRate     Float @default(0)
  taxAmount   Int   @default(0)
  totalAmount Int   @default(0)

  pdfUrl String?

  // Relasi
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])

  items InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([invoiceNumber, userId])
}

//  Model InvoiceItem (Baris Barang/Jasa)
model InvoiceItem {
  id          String @id @default(cuid())
  description String
  quantity    Int    @default(1)
  unitPrice   Int

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

// Definisi Status (State Machine)
enum InvoiceStatus {
  DRAFT // Masih diedit, belum dikirim
  PENDING // Sudah dikirim ke klien, belum dibayar
  PAID // Sudah dibayar
  OVERDUE // Telat bayar
  VOID // Dibatalkan
}
